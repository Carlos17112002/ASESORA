<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear liquidación · {{ alias }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <header class="bg-green-800 text-white py-5 shadow-md">
    <div class="max-w-6xl mx-auto px-6 flex justify-between items-center">
      <h1 class="text-2xl font-bold">Nueva liquidación · <span class="text-white/80">{{ alias }}</span></h1>
      <a href="/trabajadores/{{ alias }}/liquidaciones/" class="text-sm hover:underline">Volver a liquidaciones</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-10 space-y-10">

    {% if form_liquidacion.errors %}
      <div class="bg-red-100 text-red-700 p-4 rounded">
        <p class="font-semibold">Hay errores en el formulario:</p>
        <ul class="list-disc ml-5">
          {% for field in form_liquidacion %}
            {% for error in field.errors %}
              <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Formulario para cargar datos del contrato -->
    <form method="post" class="bg-white p-6 rounded shadow space-y-6">
      {% csrf_token %}
      <input type="hidden" name="modo" value="cargar">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium mb-1">Trabajador</label>
          {{ form_carga.trabajador }}
        </div>
        <div>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition mt-6">
            Cargar datos del contrato
          </button>
        </div>
      </div>
    </form>

    <!-- Formulario para generar liquidación -->
    <form method="post" class="bg-white p-6 rounded shadow space-y-6" x-data="calculoLiquidacion()" x-init="init()">
      {% csrf_token %}
      <input type="hidden" name="modo" value="guardar">
      <input type="hidden" name="trabajador" value="{{ form_liquidacion.trabajador.value }}">

      <!-- Mes -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Mes</label>
          {{ form_liquidacion.mes }}
        </div>
      </div>

      <!-- Haberes -->
      <h3 class="text-sm font-semibold text-green-700">Haberes</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Sueldo base</label>
          {{ form_liquidacion.sueldo_base }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Gratificación</label>
          {{ form_liquidacion.gratificacion }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Bonos</label>
          {{ form_liquidacion.bonos }}
        </div>
      </div>

      <!-- Horas extra -->
      <h3 class="text-sm font-semibold text-green-700">Horas extra</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Horas extra 50%</label>
          {{ form_liquidacion.horas_extra_50 }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Horas extra 100%</label>
          {{ form_liquidacion.horas_extra_100 }}
        </div>
      </div>

      <!-- Descuentos previsionales -->
      <h3 class="text-sm font-semibold text-green-700">Descuentos previsionales</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <p class="text-sm text-gray-600">AFP utilizada: <strong>{{ contrato.afp|title }}</strong></p>

          <label class="block text-sm font-medium mb-1">AFP</label>
          {{ form_liquidacion.afp }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Salud</label>
          {{ form_liquidacion.salud }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Seguro cesantía</label>
          {{ form_liquidacion.seguro_cesantia }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Otros descuentos</label>
          {{ form_liquidacion.otros_descuentos }}
        </div>
      </div>

      <!-- Días del mes -->
      <h3 class="text-sm font-semibold text-green-700">Días del mes</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Trabajados</label>
          {{ form_liquidacion.dias_trabajados }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Licencia</label>
          {{ form_liquidacion.dias_licencia }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Vacaciones</label>
          {{ form_liquidacion.dias_vacaciones }}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Ausente</label>
          {{ form_liquidacion.dias_ausente }}
        </div>
      </div>

      <!-- Resumen dinámico -->
      <div class="bg-gray-50 border rounded p-4 mt-6">
        <h3 class="text-sm font-semibold text-green-700 mb-2">Resumen en tiempo real</h3>
        
        <p class="text-sm text-gray-600">Total haberes: <span class="font-bold text-green-700">$<span x-text="haberes"></span></span></p>

        <div class="mt-2 space-y-1">
          <p class="text-sm text-gray-600">Descuentos:</p>
          <ul class="ml-4 text-sm text-gray-600 space-y-1">
            <li>AFP: <span class="font-bold text-red-600">$<span x-text="Math.round(afp)"></span></span></li>
            <li>Salud: <span class="font-bold text-red-600">$<span x-text="Math.round(salud)"></span></span></li>
            <li>Cesantía: <span class="font-bold text-red-600">$<span x-text="Math.round(cesantia)"></span></span></li>
            <li>Otros descuentos: <span class="font-bold text-red-600">$<span x-text="Math.round(otros)"></span></span></li>
            <li>Ausencias: <span class="font-bold text-red-600">$<span x-text="Math.round(descuento_ausente)"></span></span></li>
          </ul>
          <p class="text-sm text-gray-600 mt-1">Total descuentos: 
            <span class="font-bold text-red-600">$<span x-text="descuentos"></span></span>
          </p>
        </div>

        <p class="text-sm text-gray-600 mt-2">Horas extra: 
          <span class="font-bold text-green-700">$<span x-text="extras"></span></span>
        </p>

        <p class="text-sm text-gray-800 mt-2"><strong>Líquido pagado:</strong> 
          <span class="text-lg font-bold">$<span x-text="liquido"></span></span>
        </p>
      </div>

      <div class="pt-6">
        <button type="submit" class="bg-green-700 text-white px-6 py-2 rounded hover:bg-green-800 transition">
          Generar liquidación
        </button>
      </div>
    </form>
  </main>

  <!-- Script Alpine.js -->
<script>
function calculoLiquidacion() {
  return {
    haberes: 0,
    descuentos: 0,
    extras: 0,
    liquido: 0,
    afp: 0,
    salud: 0,
    cesantia: 0,
    otros: 0,
    descuento_ausente: 0,
    dias_mes: 30,
    jornada_diaria: 8,

    init() {
      this.recalcular();
      document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', () => this.recalcular());
      });
    },

    getValor(id) {
      const el = document.getElementById(id);
      return el ? parseFloat(el.value) || 0 : 0;
    },

    recalcular() {
      const sueldo_base = this.getValor('id_sueldo_base');
      const gratificacion = this.getValor('id_gratificacion');
      const bonos = this.getValor('id_bonos');

      const afp_valor = this.getValor('id_afp');
      const salud_valor = this.getValor('id_salud');
      const cesantia_valor = this.getValor('id_seguro_cesantia');
      const otros_valor = this.getValor('id_otros_descuentos');

      const trabajados = this.getValor('id_dias_trabajados');
      const ausente = this.getValor('id_dias_ausente');

      const extra50 = this.getValor('id_horas_extra_50');
      const extra100 = this.getValor('id_horas_extra_100');

      const sueldo_diario = sueldo_base / this.dias_mes || 0;
      const sueldo_real = sueldo_diario * trabajados || 0;
      this.descuento_ausente = sueldo_diario * ausente || 0;

      const valor_hora = sueldo_diario / this.jornada_diaria || 0;
      this.extras = Math.round(extra50 * valor_hora * 1.5 + extra100 * valor_hora * 2.0) || 0;

      this.afp = Math.round(afp_valor) || 0;
      this.salud = Math.round(salud_valor) || 0;
      this.cesantia = Math.round(cesantia_valor) || 0;
      this.otros = Math.round(otros_valor) || 0;

      this.haberes = Math.round(sueldo_real + gratificacion + bonos + this.extras);
      this.descuentos = Math.round(this.afp + this.salud + this.cesantia + this.otros + this.descuento_ausente);
      this.liquido = this.haberes - this.descuentos;
    }
  }
}
</script>

</body>
</html>
